"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[82179],{26349:e=>{e.exports=JSON.parse('{"permalink":"/blog/2022/04/22/nodejs-undici-intro","editUrl":"https://github.com/alanwei43/blog/tree/master/src/blog/2022/04/22-nodejs-undici-intro.md","source":"@site/src/blog/2022/04/22-nodejs-undici-intro.md","title":"undici \u7b80\u4ecb - Node.js","description":"undici \u4e00\u4e2a HTTP/1.1 \u5ba2\u6237\u7aef\u7b80\u4ecb","date":"2022-04-22T00:00:00.000Z","tags":[{"inline":true,"label":"node.js","permalink":"/blog/tags/node-js"},{"inline":true,"label":"undici","permalink":"/blog/tags/undici"}],"readingTime":3.455,"hasTruncateMarker":true,"authors":[{"name":"Alan","title":"Maintainer of blog","url":"https://github.com/alanwei43","imageURL":"https://github.com/alanwei43.png","key":null,"page":null}],"frontMatter":{"title":"undici \u7b80\u4ecb - Node.js","author":"Alan","author_title":"Maintainer of blog","author_url":"https://github.com/alanwei43","author_image_url":"https://github.com/alanwei43.png","tags":["node.js","undici"],"description":"undici \u4e00\u4e2a HTTP/1.1 \u5ba2\u6237\u7aef\u7b80\u4ecb","draft":false,"hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"\u67e5\u770bLinux\u7cfb\u7edf\u5f00\u673a\u65f6\u95f4","permalink":"/blog/2022/04/25/linux-reboot-time"},"nextItem":{"title":"\u53d6\u6d88 git reset \u64cd\u4f5c","permalink":"/blog/2022/04/12/git-undo-reset"}}')},28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>c});var s=i(96540);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},89571:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var s=i(26349),t=i(74848),r=i(28453);const o={title:"undici \u7b80\u4ecb - Node.js",author:"Alan",author_title:"Maintainer of blog",author_url:"https://github.com/alanwei43",author_image_url:"https://github.com/alanwei43.png",tags:["node.js","undici"],description:"undici \u4e00\u4e2a HTTP/1.1 \u5ba2\u6237\u7aef\u7b80\u4ecb",draft:!1,hide_table_of_contents:!1},c=void 0,d={authorsImageUrls:[void 0]},l=[{value:"Install",id:"install",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Body Mixins",id:"body-mixins",level:2},{value:"Common API Methods",id:"common-api-methods",level:2},{value:"<code>undici.request([url, options]): Promise</code>",id:"undicirequesturl-options-promise",level:3},{value:"<code>undici.stream([url, options, ]factory): Promise</code>",id:"undicistreamurl-options-factory-promise",level:3}];function a(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["undici \u662f\u4e00\u6b3e HTTP/1.1 \u5ba2\u6237\u7aef, \u7528\u6237HTTP\u8bf7\u6c42. \u76f8\u6bd4\u8f83Node.js\u539f\u751f\u7684",(0,t.jsx)(n.code,{children:"http"}),"\u7c7b\u5e93\u4f7f\u7528\u8d77\u6765\u66f4\u52a0\u53cb\u597d."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u672c\u6587\u7ffb\u8bd1\u81ea ",(0,t.jsx)(n.a,{href:"https://undici.nodejs.org/",children:"undici\u5b98\u65b9\u6587\u6863"}),"\nUndici \u662f\u610f\u5927\u5229\u8bed\u4e2d\u7684 11 \u7684\u610f\u601d: HTTP/1.1 -> 11 -> Eleven -> Undici."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Node.js \u521a\u521a\u53d1\u5e03\u7684 v18.0.0 \u5185\u7f6e\u4e86 fetch \u548c node",":test"," \u7b49\u6807\u51c6\u6a21\u5757, \u5176\u4e2d fetch \u6a21\u5757\u5c31\u6765\u81ea undici."]}),"\n",(0,t.jsx)(n.h2,{id:"install",children:"Install"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm i undici@5.0.0\n"})}),"\n",(0,t.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",metastring:'title="quick-start.mjs"',children:"import { request } from 'undici';\n\nconst {\n  statusCode,\n  headers,\n  trailers,\n  body // body \u662f\u4e00\u79cd\u53ea\u8bfb\u7684stream\n} = await request('http://localhost:3000/foo');\n\nconsole.log('response received', statusCode);\nconsole.log('headers', headers);\n\nfor await (const data of body) {\n  console.log('data', data); // \u8fd9\u91cc data \u662f Buffer \u7c7b\u578b, body\u5185\u5bb9\u53ef\u80fd\u88ab\u5206\u591a\u6b21\u8bfb\u53d6\n}\n\nconsole.log('trailers', trailers);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"body-mixins",children:"Body Mixins"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"body"})," mixins\u662f\u683c\u5f0f\u5316\u8bf7\u6c42\u5185\u5bb9\u548c\u54cd\u5e94\u5185\u5bb9\u6700\u5e38\u7528\u7684\u65b9\u5f0f, \u5e38\u7528mixins\u6709:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://fetch.spec.whatwg.org/#dom-body-formdata",children:(0,t.jsx)(n.code,{children:".formData()"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://fetch.spec.whatwg.org/#dom-body-json",children:(0,t.jsx)(n.code,{children:".json()"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://fetch.spec.whatwg.org/#dom-body-text",children:(0,t.jsx)(n.code,{children:".text()"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:".blob()"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u793a\u4f8b:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",metastring:'title="body-mixins.mjs"',children:"import { request } from 'undici';\n\nconst { body } = await request(\"https://blog.alanwei.com/\");\nconst text = await body.text(); // \u54cd\u5e94\u5185\u5bb9\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["body\u662f\u4e00\u4e2a\u53ea\u8bfb\u6d41, \u53ea\u80fd\u8bfb\u53d6\u4e00\u6b21, \u4e00\u65e6\u8c03\u7528mixin\u8bfb\u53d6\u5185\u5bb9\u4e4b\u540e, body\u5c31\u4e0d\u80fd\u518d\u4f7f\u7528\u4e86. \u5982\u679c\u5728body\u4e0a\u591a\u6b21\u8c03\u7528mixin, \u6bd4\u5982 ",(0,t.jsx)(n.code,{children:"body.json(); body.text();"})," \u5c06\u4f1a\u5f97\u5230\u4e00\u4e2aPromise reject, \u5f02\u5e38\u5185\u5bb9\u4e3a ",(0,t.jsx)(n.code,{children:"TypeError: unusable"}),". \u5982\u679c\u9700\u8981\u591a\u6b21\u4f7f\u7528body, \u6216\u8005body\u4e0d\u662fJSON\u3001Form\u683c\u5f0f, \u6700\u4f73\u5b9e\u8df5\u662f\u4f7f\u7528mixin ",(0,t.jsx)(n.code,{children:".text()"})," \u8bfb\u53d6\u6587\u672c\u5185\u5bb9\u540e, \u518d\u624b\u52a8\u683c\u5f0f\u5316\u6210\u671f\u671b\u7684\u683c\u5f0f. \u66f4\u591abody mixin\u53c2\u8003 ",(0,t.jsx)(n.a,{href:"https://fetch.spec.whatwg.org/#body-mixin",children:"Fetch Standard"}),"."]})}),"\n",(0,t.jsx)(n.h2,{id:"common-api-methods",children:"Common API Methods"}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u7ae0\u8282\u5c55\u793a\u6700\u5e38\u7528\u7684\u51e0\u4e2aAPI\u65b9\u6cd5\u7684\u6587\u6863, \u5176\u4ed6API\u6587\u6863\u8bbf\u95ee",(0,t.jsx)(n.a,{href:"https://undici.nodejs.org/#/docs/",children:"docs"})]}),"\n",(0,t.jsx)(n.h3,{id:"undicirequesturl-options-promise",children:(0,t.jsx)(n.code,{children:"undici.request([url, options]): Promise"})}),"\n",(0,t.jsx)(n.p,{children:"\u53c2\u6570"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"url"})," ",(0,t.jsx)(n.code,{children:"string | URL | UrlObject"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"options"})," ",(0,t.jsx)(n.a,{href:"https://undici.nodejs.org/#/docs/api/Dispatcher?id=parameter-requestoptions",children:(0,t.jsx)(n.code,{children:"RequestOptions"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"dispatcher"})," ",(0,t.jsx)(n.code,{children:"Dispatcher"})," - \u9ed8\u8ba4\u4f7f\u7528",(0,t.jsx)(n.a,{href:"https://undici.nodejs.org/#/?id=undicigetglobaldispatcher",children:"getGlobalDispatcher"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"method"})," ",(0,t.jsx)(n.code,{children:"String"})," - \u5982\u679c\u4f20\u4e86 ",(0,t.jsx)(n.code,{children:"options.body"}),", \u9ed8\u8ba4\u662f ",(0,t.jsx)(n.code,{children:"PUT"}),", \u5426\u5219\u9ed8\u8ba4\u662f ",(0,t.jsx)(n.code,{children:"GET"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"maxRedirections"})," ",(0,t.jsx)(n.code,{children:"Integer"})," - \u9ed8\u8ba4 ",(0,t.jsx)(n.code,{children:"0"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u8fd4\u56de\u4e00\u4e2apromise\u7ed3\u679c"}),"\n",(0,t.jsx)(n.h3,{id:"undicistreamurl-options-factory-promise",children:(0,t.jsx)(n.code,{children:"undici.stream([url, options, ]factory): Promise"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"url"})," ",(0,t.jsx)(n.code,{children:"string | URL | UrlObject"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"options"})," ",(0,t.jsx)(n.code,{children:"StreamOptions"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"dispatcher"})," \u540c ",(0,t.jsx)(n.code,{children:"undici.request"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"method"})," \u540c ",(0,t.jsx)(n.code,{children:"undici.request"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"maxRedirections"})," \u540c ",(0,t.jsx)(n.code,{children:"undici.request"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"factory"})," ",(0,t.jsx)(n.code,{children:"Dispatcher.stream.factory"})," \u53c2\u8003\u4ee5\u4e0b\u4ee3\u7801"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"undici.stream"})," \u662f ",(0,t.jsx)(n.code,{children:"Dispatcher.request"}),"\u7684\u5feb\u901f\u7248\u672c, \u8be5\u65b9\u6cd5\u671f\u671b\u7684",(0,t.jsx)(n.code,{children:"facotry"}),"\u53c2\u6570\u9700\u8981\u8fd4\u56de\u4e00\u4e2a\u53ef\u5199\u7684\u6d41",(0,t.jsx)(n.a,{href:"https://nodejs.org/api/stream.html#stream_class_stream_writable",children:(0,t.jsx)(n.code,{children:"stream.Writable"})}),", \u7528\u4e8e\u5199\u5165\u54cd\u5e94\u5185\u5bb9."]}),"\n",(0,t.jsxs)(n.p,{children:["\u5f53\u7528\u6237\u60f3\u628a\u54cd\u5e94\u5185\u5bb9\u5199\u5165\u4e00\u4e2a\u53ef\u5199\u5165\u6d41(",(0,t.jsx)(n.code,{children:"stream.Writable"}),")\u65f6, \u501f\u52a9",(0,t.jsx)(n.code,{children:"factory"}),", \u53ef\u4ee5\u907f\u514d\u521b\u5efa\u4e2d\u95f4\u7684",(0,t.jsx)(n.code,{children:"stream.Readable"}),"\u6d41, \u7528\u4e8e\u6539\u5584\u6027\u80fd."]}),"\n",(0,t.jsx)(n.p,{children:"\u793a\u4f8b1:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",metastring:'title="undici-stream.mjs"',children:'import { stream } from \'undici\';\nimport { Writable } from "stream";\n\nconst bufs = [];\nconst response = await stream("https://blog.alanwei.com", {\n  method: "GET",\n  opaque: { bufs }\n}, ({ statusCode, headers, opaque: { bufs } }) => {\n  return new Writable({\n    write(chunk, encoding, callback) {\n      bufs.push(chunk);\n      callback();\n    }\n  })\n});\n\nconst html = Buffer.concat(bufs).toString("utf-8"); // \u8bf7\u6c42\u54cd\u5e94\u5185\u5bb9\nconst equals = bufs === response.opaque.bufs; // => true\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u793a\u4f8b2:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",metastring:'title="client-stream.mjs"',children:'import { Client } from \'undici\';\nimport { Writable } from "stream";\n\nconst buffers = [];\n\nconst client = new Client("https://blog.alanwei.com");\nconst response = await client.stream({\n  path: "/me/",\n  method: "GET",\n  opaque: {\n    data: buffers\n  }\n}, ({ opaque: { data } }) => {\n  return new Writable({\n    write(chunk, encoding, callback) {\n      buffers.push(chunk);\n      callback();\n    }\n  })\n});\n\nconsole.log(Buffer.concat(response.opaque.data).toString("utf-8")); // \u6253\u5370\u54cd\u5e94\u5185\u5bb9\nconsole.log(buffers === response.opaque.data); // => true\n'})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}}}]);