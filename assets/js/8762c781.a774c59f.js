"use strict";(self.webpackChunkalan_blog=self.webpackChunkalan_blog||[]).push([[53218],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>m});var o=t(67294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,o,l=function(e,n){if(null==e)return{};var t,o,l={},r=Object.keys(e);for(o=0;o<r.length;o++)t=r[o],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)t=r[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var s=o.createContext({}),d=function(e){var n=o.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},u=function(e){var n=d(e.components);return o.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},p=o.forwardRef((function(e,n){var t=e.components,l=e.mdxType,r=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=d(t),m=l,g=p["".concat(s,".").concat(m)]||p[m]||c[m]||r;return t?o.createElement(g,a(a({ref:n},u),{},{components:t})):o.createElement(g,a({ref:n},u))}));function m(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var r=t.length,a=new Array(r);a[0]=p;var i={};for(var s in n)hasOwnProperty.call(n,s)&&(i[s]=n[s]);i.originalType=e,i.mdxType="string"==typeof e?e:l,a[1]=i;for(var d=2;d<r;d++)a[d]=t[d];return o.createElement.apply(null,a)}return o.createElement.apply(null,t)}p.displayName="MDXCreateElement"},3413:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>d});var o=t(87462),l=(t(67294),t(3905));const r={tags:["nodejs","esbuild","FSLegacyMainResolve"]},a="Node esBuild suddenly failing with FSLegacyMainResolve problem",i={permalink:"/blog/2024/12/14/node-esbuild-FSLegacyMainResolve",editUrl:"https://github.com/alanwei43/blog/tree/master/src/blog/2024/12-14-node-esbuild-FSLegacyMainResolve.md",source:"@site/src/blog/2024/12-14-node-esbuild-FSLegacyMainResolve.md",title:"Node esBuild suddenly failing with FSLegacyMainResolve problem",description:"ref Node esBuild suddenly failing with FSLegacyMainResolve problem",date:"2024-12-14T00:00:00.000Z",formattedDate:"December 14, 2024",tags:[{label:"nodejs",permalink:"/blog/tags/nodejs"},{label:"esbuild",permalink:"/blog/tags/esbuild"},{label:"FSLegacyMainResolve",permalink:"/blog/tags/fs-legacy-main-resolve"}],readingTime:1.65,hasTruncateMarker:!0,authors:[],frontMatter:{tags:["nodejs","esbuild","FSLegacyMainResolve"]},prevItem:{title:"CSS Position Sticky",permalink:"/blog/2024/12/14/css-position-sticky"},nextItem:{title:"Ubuntu DNS \u8bbe\u7f6e",permalink:"/blog/2024/12/03/ubuntu-dns"}},s={authorsImageUrls:[]},d=[{value:"Question",id:"question",level:2},{value:"Answer",id:"answer",level:2}],u={toc:d};function c(e){let{components:n,...t}=e;return(0,l.kt)("wrapper",(0,o.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/77630548/node-esbuild-suddenly-failing-with-fslegacymainresolve-problem"},"ref Node esBuild suddenly failing with FSLegacyMainResolve problem")),(0,l.kt)("h2",{id:"question"},"Question"),(0,l.kt)("p",null,"I have a Node project that builds fine locally, and has historically built with no problems on the GitLab CI/CD server. However, suddenly, the pipeline build fails on the server with no changes to the code. I even opened several branches for past commits that previously built fine, and they also fail on the server."),(0,l.kt)("p",null,'I\'m mostly trying to understand what this error "means":'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"const resolvedOption = FSLegacyMainResolve(packageJsonUrlString, packageConfig.main, baseStringified);\n                         ^\nTypeError: The URL must be of scheme file: <etc...>\n")),(0,l.kt)("p",null,"I have to assume something changed in the build environment, it's not able to pull down a package suddenly, or similar, but there's nothing really specific about what the problem might be. I'm looking for pointers about why this is occurring, and possibly how to troubleshoot."),(0,l.kt)("p",null,"Relevant error from the log on the build server is:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"$ npm install\nadded 362 packages, and audited 363 packages in 17s\n47 packages are looking for funding\n  run `npm fund` for details\nfound 0 vulnerabilities\n$ echo \"Compile complete.\"\nCompile complete.\n$ npm run build\n> my-project@1.0.0 build\n> tsc -skipLibCheck && node esbuild.config.mjs production && npm pack\nnode:internal/modules/esm/resolve:205\n  const resolvedOption = FSLegacyMainResolve(packageJsonUrlString, packageConfig.main, baseStringified);\n                         ^\nTypeError: The URL must be of scheme file:\n    at legacyMainResolve (node:internal/modules/esm/resolve:205:26)\n    at packageResolve (node:internal/modules/esm/resolve:831:14)\n    at moduleResolve (node:internal/modules/esm/resolve:901:20)\n    at defaultResolve (node:internal/modules/esm/resolve:1121:11)\n    at ModuleLoader.defaultResolve (node:internal/modules/esm/loader:396:12)\n    at ModuleLoader.resolve (node:internal/modules/esm/loader:365:25)\n    at ModuleLoader.getModuleJob (node:internal/modules/esm/loader:240:38)\n    at ModuleWrap.<anonymous> (node:internal/modules/esm/module_job:85:39)\n    at link (node:internal/modules/esm/module_job:84:36) {\n  code: 'ERR_INVALID_URL_SCHEME'\n}\nNode.js v20.10.0\nCleaning up project directory and file based variables 00:01\nERROR: Job failed: exit code 1\n")),(0,l.kt)("p",null,"Again, this runs just fine locally, same version of Node.js, etc. I've cleared local npm cache, deleted node_modules, etc, all in an attempt to potentially replicate the server-side state, but still everything works fine locally."),(0,l.kt)("h2",{id:"answer"},"Answer"),(0,l.kt)("p",null,"I was facing the same issue, but this worked for me"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Delete the node_modules directory: ",(0,l.kt)("inlineCode",{parentName:"li"},"rm -rf node_modules")),(0,l.kt)("li",{parentName:"ol"},"Install dependencies with the --legacy-peer-deps flag: ",(0,l.kt)("inlineCode",{parentName:"li"},"npm install --legacy-peer-deps"))))}c.isMDXComponent=!0}}]);