"use strict";(self.webpackChunkalan_blog=self.webpackChunkalan_blog||[]).push([[36882],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),h=s(n),d=r,k=h["".concat(c,".").concat(d)]||h[d]||p[d]||i;return n?a.createElement(k,l(l({ref:t},u),{},{components:n})):a.createElement(k,l({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=h;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var s=2;s<i;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},41979:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return c},default:function(){return d},frontMatter:function(){return o},metadata:function(){return s},toc:function(){return p}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),l=["components"],o={title:"\u7f13\u5b58",hide_title:!1,hide_table_of_contents:!1,keywords:["okhttp","java"],description:"OkHttp \u7f13\u5b58"},c=void 0,s={unversionedId:"articles/okhttp-guide/caching",id:"articles/okhttp-guide/caching",title:"\u7f13\u5b58",description:"OkHttp \u7f13\u5b58",source:"@site/src/docs/articles/okhttp-guide/3-caching.md",sourceDirName:"articles/okhttp-guide",slug:"/articles/okhttp-guide/caching",permalink:"/docs/articles/okhttp-guide/caching",editUrl:"https://github.com/alanwei43/blog/tree/master/src/docs/articles/okhttp-guide/3-caching.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"\u7f13\u5b58",hide_title:!1,hide_table_of_contents:!1,keywords:["okhttp","java"],description:"OkHttp \u7f13\u5b58"},sidebar:"tutorialSidebar",previous:{title:"\u8c03\u7528",permalink:"/docs/articles/okhttp-guide/calls"},next:{title:"\u8fde\u63a5",permalink:"/docs/articles/okhttp-guide/connections"}},u={},p=[{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:2},{value:"EventListener\u4e8b\u4ef6",id:"eventlistener\u4e8b\u4ef6",level:3},{value:"Cache Hit(\u7f13\u5b58\u547d\u4e2d)",id:"cache-hit\u7f13\u5b58\u547d\u4e2d",level:4},{value:"Cache Miss",id:"cache-miss",level:4},{value:"Conditional Cache Hit",id:"conditional-cache-hit",level:4},{value:"Cache directory",id:"cache-directory",level:2},{value:"Pruning the Cache",id:"pruning-the-cache",level:2},{value:"Troubleshooting",id:"troubleshooting",level:3},{value:"Overriding normal cache behaviour\xb6",id:"overriding-normal-cache-behaviour",level:3}],h={toc:p};function d(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"OkHttp\u5b9e\u73b0\u4e86\u4e00\u4e2a\u53ef\u9009\u7684\u3001\u9ed8\u8ba4\u5173\u95ed\u7684\u7f13\u5b58 ",(0,i.kt)("inlineCode",{parentName:"p"},"Cache"),"\u3002"),(0,i.kt)("h2",{id:"\u57fa\u672c\u4f7f\u7528"},"\u57fa\u672c\u4f7f\u7528"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'private val client: OkHttpClient = OkHttpClient.Builder()\n    .cache(Cache(\n        directory = File(application.cacheDir, "http_cache"),\n        // $0.05 worth of phone storage in 2020\n        maxSize = 50L * 1024L * 1024L // 50 MiB\n    ))\n    .build()\n')),(0,i.kt)("h3",{id:"eventlistener\u4e8b\u4ef6"},"EventListener\u4e8b\u4ef6"),(0,i.kt)("p",null,"Cache\u4e8b\u4ef6\u901a\u8fc7 EventListener API \u66b4\u9732\uff0c\u5178\u578b\u573a\u666f\u5982\u4e0b:"),(0,i.kt)("h4",{id:"cache-hit\u7f13\u5b58\u547d\u4e2d"},"Cache Hit(\u7f13\u5b58\u547d\u4e2d)"),(0,i.kt)("p",null,"\u5728\u7406\u60f3\u7684\u60c5\u51b5\u4e0b\uff0c\u7f13\u5b58\u5728\u4e0d\u9700\u8981\u8bf7\u6c42\u7f51\u7edc\u7684\u60c5\u51b5\u4e0b\u54cd\u5e94\u8bf7\u6c42\u3002\u8fd9\u4f1a\u8df3\u8fc7\u901a\u8fc7\u6240\u9700\u7684\u4e8b\u4ef6\uff0c\u6bd4\u5982DNS\u3001\u7f51\u7edc\u8fde\u63a5\u4ee5\u53ca\u54cd\u5e94\u4f53\u7684\u4e0b\u8f7d\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"CallStart"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"CallStart")),(0,i.kt)("li",{parentName:"ul"},"CallEnd")),(0,i.kt)("h4",{id:"cache-miss"},"Cache Miss"),(0,i.kt)("p",null,"Under a cache miss the normal request events are seen but an additional event shows the presence of the cache. Cache Miss will be typical if the item has not been read from the network, is uncacheable, or is past it\u2019s lifetime based on Response cache headers."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"CallStart"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"CacheMiss")),(0,i.kt)("li",{parentName:"ul"},"ProxySelectStart"),(0,i.kt)("li",{parentName:"ul"},"\u2026 Standard Events \u2026"),(0,i.kt)("li",{parentName:"ul"},"CallEnd")),(0,i.kt)("h4",{id:"conditional-cache-hit"},"Conditional Cache Hit"),(0,i.kt)("p",null,"When cache flags require checking the cache results are still valid an early cacheConditionalHit event is received followed by a cache hit or miss. Critically in the cache hit scenario the server won\u2019t send the response body."),(0,i.kt)("p",null,"The response will have non-null ",(0,i.kt)("inlineCode",{parentName:"p"},"cacheResponse")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"networkResponse"),". The ",(0,i.kt)("inlineCode",{parentName:"p"},"cacheResponse")," will be used as the top level response only if the response code is HTTP/1.1 304 Not Modified."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"CallStart"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"CacheConditionalHit")),(0,i.kt)("li",{parentName:"ul"},"ConnectionAcquired"),(0,i.kt)("li",{parentName:"ul"},"\u2026 Standard Events\u2026"),(0,i.kt)("li",{parentName:"ul"},"ResponseBodyEnd (0 bytes)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"CacheHit")),(0,i.kt)("li",{parentName:"ul"},"ConnectionReleased"),(0,i.kt)("li",{parentName:"ul"},"CallEnd")),(0,i.kt)("h2",{id:"cache-directory"},"Cache directory"),(0,i.kt)("p",null,"The cache directory must be exclusively owned by a single instance."),(0,i.kt)("p",null,"Deleting the cache when it is no longer needed can be done. However this may delete the purpose of the cache which is designed to persist between app restarts."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"cache.delete()\n")),(0,i.kt)("h2",{id:"pruning-the-cache"},"Pruning the Cache"),(0,i.kt)("p",null,"Pruning the entire Cache to clear space temporarily can be done using evictAll."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"cache.evictAll()\n")),(0,i.kt)("p",null,"Removing individual items can be done using the urls iterator. This would be typical after a user initiates a force refresh by a pull to refresh type action."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'val urlIterator = cache.urls()\nwhile (urlIterator.hasNext()) {\n    if (urlIterator.next().startsWith("https://www.google.com/")) {\n    urlIterator.remove()\n    }\n}\n')),(0,i.kt)("h3",{id:"troubleshooting"},"Troubleshooting"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Valid cacheable responses are not being cached")),(0,i.kt)("p",null,"Make sure you are reading responses fully as unless they are read fully, cancelled or stalled Responses will not be cached."),(0,i.kt)("h3",{id:"overriding-normal-cache-behaviour"},"Overriding normal cache behaviour\xb6"),(0,i.kt)("p",null,"See Cache documentation. ",(0,i.kt)("a",{parentName:"p",href:"https://square.github.io/okhttp/4.x/okhttp/okhttp3/-cache/"},"https://square.github.io/okhttp/4.x/okhttp/okhttp3/-cache/")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("a",{parentName:"p",href:"https://square.github.io/okhttp/caching/"},"\u539f\u6587 - Caching"))))}d.isMDXComponent=!0}}]);