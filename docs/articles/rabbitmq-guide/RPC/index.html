<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-articles/rabbitmq-guide/RPC">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Remote procedure call (RPC)  -  Alan&#x27;s Blog</title><meta data-rh="true" name="baidu-site-verification" content="code-7RGpEH8jty"><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://blog.alanwei.com/docs/articles/rabbitmq-guide/RPC"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Remote procedure call (RPC)  -  Alan&#x27;s Blog"><meta data-rh="true" name="description" content="英文原文"><meta data-rh="true" property="og:description" content="英文原文"><meta data-rh="true" name="keywords" content="rabbitmq"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://blog.alanwei.com/docs/articles/rabbitmq-guide/RPC"><link data-rh="true" rel="alternate" href="https://blog.alanwei.com/docs/articles/rabbitmq-guide/RPC" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.alanwei.com/docs/articles/rabbitmq-guide/RPC" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://7SQ6A6EP36-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Alan&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Alan&#39;s Blog Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Alan&#39;s Blog" href="/opensearch.xml">

<script src="/scripts/baidu.js"></script>
<script src="/scripts/bing-clarity.js"></script><link rel="stylesheet" href="/assets/css/styles.511fea77.css">
<link rel="preload" href="/assets/js/runtime~main.992dcfc3.js" as="script">
<link rel="preload" href="/assets/js/main.211e81ce.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Alan&#x27;s Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Documents</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/me">Abount me</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/alanwei43" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"><b>Alan&#x27;s Blog</b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Home</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/articles/">Articles</a><button aria-label="Toggle the collapsible sidebar category &#x27;Articles&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/articles/es6-in-depth/introduction">深入浅出ES6</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/articles/why-java-sucks-and-csharp-rocks/compare-purpose">Why Java Sucks and C# Rocks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/articles/okhttp-guide/overview">OkHttp 简介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/articles/rabbitmq-guide/install">RabbitMQ 简介</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/install">安装</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/hello-world">Hello World</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/WorkQueues">Work Queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/Publish-Subscribe">Publish/Subscribe</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/Routing">Routing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/Topic">Topics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/articles/rabbitmq-guide/RPC">Remote procedure call (RPC)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/articles/vsc-container/">Remote Container - VSCode</a><button aria-label="Toggle the collapsible sidebar category &#x27;Remote Container - VSCode&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/articles/nodejs-typescript/worker-threads">Node.js TypeScript</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/collections/">Collections</a><button aria-label="Toggle the collapsible sidebar category &#x27;Collections&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/docusaurus/">Docusaurus</a><button aria-label="Toggle the collapsible sidebar category &#x27;Docusaurus&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/reading/">Reading</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reading&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/articles/"><span itemprop="name">Articles</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RabbitMQ 简介</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Remote procedure call (RPC)</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Remote procedure call (RPC)</h1></header><p><a href="http://www.rabbitmq.com/tutorials/tutorial-six-dotnet.html" target="_blank" rel="noopener noreferrer">英文原文</a></p><p>在第二个教程里我们学习了如何使用工作队列在多个工作者进程之间分发耗时任务。</p><p>但是如果我们需要在远程计算机上运行一个函数并等待结果该如何做呢？嗯，这种事完全不同的使用场景。这种模式通常被称作远程处理调用（Remote Procedure Call）或者简称RPC。</p><p>在这个教程里我们将会使用RabbitMQ建立RPC系统：一个客户端和一个可伸缩的RPC服务器。因为我们没有值得分发的耗时任务，所以我们将会创建一个返回斐波那契数的虚拟RPC服务。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="client-interface">Client interface<a class="hash-link" href="#client-interface" title="Direct link to heading">​</a></h2><p>为了展示如何使用一个RPC服务我们将会创建一个简单的客户端。它将会暴露一个名为call的方法，这个方法发送一个RPC请求并且阻塞直到接收到答案（响应）：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var rpcClient = new RPCClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Console.WriteLine(&quot; [x] Requesting fib(30)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var response = rpcClient.Call(&quot;30&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Console.WriteLine(&quot; [.] Got &#x27;{0}&#x27;&quot;, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpcClient.Close();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note:</p><p>虽然RPC是一个用于计算的常见模式，但它常常是危险的。当一个程序员没有意识到函数调用是否是本地时或者是一个很慢的RPC调用时问题就会产生。</p><p>解决上面的缺陷，考虑以下建议：</p><p>搞明白哪个函数是本地调用，哪一个是远程调用。</p><p>组织你的系统。让组件之间的依赖保持清晰。</p><p>错误处理情况。当RPC服务器长时间罢工客户端应该怎么反应？</p><p>当上述问题不清楚时避免使用RPC。如果你搞明白了，你应该使用一个阻塞的异步管道取代RPC，结果被异步推送到下一个计算阶段。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="callback-queue">Callback queue<a class="hash-link" href="#callback-queue" title="Direct link to heading">​</a></h2><p>通常通过RabbitMQ执行RPC调用是容易的。一个客户端发送一个请求消息，服务器端回复响应消息。为了能够接受响应我们需要发送一个带有“callback”队列地址的请求。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var corrId = Guid.NewGuid().ToString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var props = channel.CreateBasicProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.ReplyTo = replyQueueName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.CorrelationId = corrId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var messageBytes = Encoding.UTF8.GetBytes(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.BasicPublish(exchange: &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     routingKey: &quot;rpc_queue&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     basicProperties: props,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     body: messageBytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ... then code to read a response message from the callback_queue ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note:
消息属性</p><p>AMQP协议给消息预先定义了14个属性集。大部分消暑极少使用，下面几个例外（下面几个常用）：</p><p><code>deliveryMode</code>: 使消息持久化（值为2）或者短暂的（发后即忘模式，其他任意值）。你也许还记得第二个教程里提到的这个属性。</p><p><code>contentType</code>: 用于描述编码的mime-type。比如对于常用的JSON编码设置属性值为application/json是一个好的实践。</p><p><code>replyTo</code>: 一般用于命名回调队列。</p><p><code>correlationId</code>: 常用于关联RPC请求等待响应。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="correlation-id">Correlation Id<a class="hash-link" href="#correlation-id" title="Direct link to heading">​</a></h2><p>在上面发送请求之前的方法里，我们建议为每一个RPC请求创建一个回调队列。那是非常低效的。幸运的是有一个更好的办法：让我们创建单个回调队列每客户端。</p><p>这会产生新的问题，响应不清楚是哪个队列发出的请求。这时候需要使用correlationId属性。我们打算把每个请求的correlationId设置成唯一值。之后，我们在回调队列里接收一条消息，我们将会查看这个属性，然后基于这个属性我们能够匹配这个请求的响应。如果我们看到一个位置的correlationId值，我们可以安全地丢弃消息，这条消息不属于我们的请求。</p><p>You may ask, why should we ignore unknown messages in the callback queue, rather than failing with an error? It&#x27;s due to a possibility of a race condition on the server side. Although unlikely, it is possible that the RPC server will die just after sending us the answer, but before sending an acknowledgment message for the request. If that happens, the restarted RPC server will process the request again. That&#x27;s why on the client we must handle the duplicate responses gracefully, and the RPC should ideally be idempotent. 你也许会问为什么我们在回调队列里忽略未知消息，而不是引发一个错误然后失败。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="http://www.rabbitmq.com/img/tutorials/python-six.png" alt="summary" class="img_ev3q"></p><p>我们的RPC像这样工作：</p><p>当我们的客户端启动时，它会创建一个匿名排他的回调队列。 </p><p>对于每一个RPC请求，客户端发送的消息都带有两个属性：replayTo，用来标识回调队列，correlationId，为每一次请求设置唯一标识。</p><p>请求被发送到一个<code>rpc_queue</code>队列。</p><p>RPC工作线程（也称作服务器）等待那个队列（rpc_queue）的请求。当请求出现，RPC工作线程开始执行作业并且把作业的结果以消息的形式使用replyTo字段发回客户端，</p><p>客户端在回调队列里等待数据。当消息出现，客户端检查<code>correlationId</code>属性。如果这个属性值和请求里的值匹配，它就会把这个响应返回给应用。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="putting-it-all-together">Putting it all together<a class="hash-link" href="#putting-it-all-together" title="Direct link to heading">​</a></h2><p>斐波那契任务:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static int fib(int n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (n == 0 || n == 1) return n;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fib(n - 1) + fib(n - 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们声明我们的斐波那契函数。假设只有正整数有效。（不要这个函数对大数能工作，这可能是最慢的递归实现）。</p><p> RPC server的代码如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using RabbitMQ.Client;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using RabbitMQ.Client.Events;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RPCServer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void Main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var factory = new ConnectionFactory() { HostName = &quot;localhost&quot; };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using(var connection = factory.CreateConnection())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using(var channel = connection.CreateModel())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.QueueDeclare(queue: &quot;rpc_queue&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 durable: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 exclusive: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 autoDelete: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 arguments: null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.BasicQos(0, 1, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var consumer = new QueueingBasicConsumer(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.BasicConsume(queue: &quot;rpc_queue&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 noAck: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 consumer: consumer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine(&quot; [x] Awaiting RPC requests&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                string response = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var ea = (BasicDeliverEventArgs)consumer.Queue.Dequeue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var body = ea.Body;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var props = ea.BasicProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var replyProps = channel.CreateBasicProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                replyProps.CorrelationId = props.CorrelationId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    var message = Encoding.UTF8.GetString(body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    int n = int.Parse(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Console.WriteLine(&quot; [.] fib({0})&quot;, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response = fib(n).ToString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                catch(Exception e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Console.WriteLine(&quot; [.] &quot; + e.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    response = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                finally</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    var responseBytes = Encoding.UTF8.GetBytes(response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel.BasicPublish(exchange: &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         routingKey: props.ReplyTo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         basicProperties: replyProps,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         body: responseBytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel.BasicAck(deliveryTag: ea.DeliveryTag,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     multiple: false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Assumes only valid positive integer input.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Don&#x27;t expect this one to work for big numbers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// and it&#x27;s probably the slowest recursive implementation possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int fib(int n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(n == 0 || n == 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return n;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fib(n - 1) + fib(n - 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>服务器端代码更简单明了：</p><p>通常我开始先建立连接，通道和声明队列。</p><p>我们也许想运行更多的服务器来处理。为了在多个服务器上负载均衡我们需要设置<code>channel.basicQos</code>的<code>preferchCount</code>。</p><p>我们使用<code>basicConsume</code>来访问队列。然后为了等待请求消息我们进入while循环，执行工作并发送响应。</p><p>RPC客户端代码如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using RabbitMQ.Client;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using RabbitMQ.Client.Events;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RPCClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private IConnection connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private IModel channel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private string replyQueueName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private QueueingBasicConsumer consumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RPCClient()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var factory = new ConnectionFactory() { HostName = &quot;localhost&quot; };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connection = factory.CreateConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel = connection.CreateModel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        replyQueueName = channel.QueueDeclare().QueueName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer = new QueueingBasicConsumer(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.BasicConsume(queue: replyQueueName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             noAck: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             consumer: consumer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Call(string message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var corrId = Guid.NewGuid().ToString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var props = channel.CreateBasicProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.ReplyTo = replyQueueName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.CorrelationId = corrId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var messageBytes = Encoding.UTF8.GetBytes(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.BasicPublish(exchange: &quot;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             routingKey: &quot;rpc_queue&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             basicProperties: props,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             body: messageBytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var ea = (BasicDeliverEventArgs)consumer.Queue.Dequeue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(ea.BasicProperties.CorrelationId == corrId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Encoding.UTF8.GetString(ea.Body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void Close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connection.Close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RPC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void Main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var rpcClient = new RPCClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine(&quot; [x] Requesting fib(30)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var response = rpcClient.Call(&quot;30&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Console.WriteLine(&quot; [.] Got &#x27;{0}&#x27;&quot;, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcClient.Close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>客户端代码涉及了稍微多一些：</p><p>我们建立一个连接和一个通道并且声明一个排他的回调队列用于回复。</p><p>我们订阅了回调队列，所以我们能够接收RPC响应</p><p>我们的call方法执行实际的RPC请求。</p><p>在这里，我们首先声称一个唯一的<code>correlationId</code>数并保存它，在while循环里将会使用这个值捕获合适的响应。</p><p>下面我们发布请求消息，并带有replayTo和correlationId两个属性。</p><p>这个时候我们可以坐下来然后等待直到合适的响应到达。</p><p>while循环做的事情很简单，对于每一个响应消息它（这while循环那段代码）都检查correlationId是否是我们查找的那个。如果是，它会保存响应。最终我们给用户返回响应。</p><p>执行客户端请求：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RPCClient fibonacciRpc = new RPCClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(&quot; [x] Requesting fib(30)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String response = fibonacciRpc.call(&quot;30&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(&quot; [.] Got &#x27;&quot; + response + &quot;&#x27;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fibonacciRpc.close();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在是时候查看我们完整的例子源码了（包括基本的异常处理）：RPCClient.cs和RPCServer.cs。</p><p>像往常一样编译：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ csc /r:&quot;RabbitMQ.Client.dll&quot; RPCClient.cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ csc /r:&quot;RabbitMQ.Client.dll&quot; RPCServer.cs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们的RPC服务已经准备好了。我们可以启动服务器了：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ RPCServer.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [x] Awaiting RPC requests</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>运行下面客户端请求一个斐波那契数：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ RPCClient.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [x] Requesting fib(30)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>目前这里的设计不是一个RPC服务唯一可能的实现，但是它给出了一些重要的建议：</p><p>如果RPC服务器很慢，你可以运行一个新的RPC服务器。试着在一个新的控制台运行第二个RPCServer。</p><p>在客户端，RPC要求客户端只能发送和接收一条消息。没有要求像queueDeclare的同步调用。对于单个RPC请求，RPC客户端只需要一次网络来回就可以得到结果。</p><p>目前我们的代码还是非常简单，而且没有尝试解决更复杂（但更重要）的问题，比如：</p><p>如果没有运行的服务器，客户端应该如何反应？</p><p>对于RPC，客户端是否应该有某些类型的超时？</p><p>如果服务器发生故障或者抛出异常，应该把它转发到客户端吗？</p><p>在处理之前阻止无效入站消息（比如检查限制，类型）</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/articles/rabbitmq-guide/Topic"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Topics</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/articles/vsc-container/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">VS Code 容器开发简介</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#client-interface" class="table-of-contents__link toc-highlight">Client interface</a></li><li><a href="#callback-queue" class="table-of-contents__link toc-highlight">Callback queue</a></li><li><a href="#correlation-id" class="table-of-contents__link toc-highlight">Correlation Id</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#putting-it-all-together" class="table-of-contents__link toc-highlight">Putting it all together</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Recommend</h4><ul class="footer__items"><li class="footer__item"> <a class="footer__link-item" href="/docs/articles/es6-in-depth/introduction">深入浅出ES6 - InfoQ.cn</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/articles/why-java-sucks-and-csharp-rocks/compare-purpose">Why Java Sucks and C# Rocks - 赵劼</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/reading">阅读笔记</a> </li></ul></div><div class="col footer__col"><h4 class="footer__title">Translate</h4><ul class="footer__items"><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/guides/blog">Docusaurus Blog</a> </li><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/guides/docs/markdown-features">Docusaurus Markdown</a> </li><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/blog/2022/03/12/caddy-intro">Caddy 简介</a> </li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"> <a href="https://github.com/alanwei43/node-io-lib" target="_blank" rel="noopener noreferrer" class="footer__link-item">node-io-lib - GitHub</a> </li><li class="footer__item"> <a href="https://github.com/alanwei43/docker-puppeteer" target="_blank" rel="noopener noreferrer" class="footer__link-item">docker-puppeteer - GitHub</a> </li><li class="footer__item"> <a href="https://github.com/alanwei43/code-server" target="_blank" rel="noopener noreferrer" class="footer__link-item">code-server - GitHub</a> </li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Alan&#x27;s Blog<!-- --> <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer"> </a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.992dcfc3.js"></script>
<script src="/assets/js/main.211e81ce.js"></script>
</body>
</html>