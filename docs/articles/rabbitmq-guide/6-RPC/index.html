<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Alan's Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Alan's Blog Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WSJXZXE31N"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WSJXZXE31N",{anonymize_ip:!0})</script>
<script src="scripts/baidu.js"></script><title data-react-helmet="true">Remote procedure call (RPC)  -  Alan&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Remote procedure call (RPC)  -  Alan&#x27;s Blog"><meta data-react-helmet="true" name="description" content="英文原文"><meta data-react-helmet="true" property="og:description" content="英文原文"><meta data-react-helmet="true" name="keywords" content="rabbitmq"><meta data-react-helmet="true" property="og:url" content="https://blog.alanwei.com/docs/articles/rabbitmq-guide/6-RPC"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://blog.alanwei.com/docs/articles/rabbitmq-guide/6-RPC"><link rel="stylesheet" href="/styles.66a1e391.css">
<link rel="preload" href="/styles.2421a4af.js" as="script">
<link rel="preload" href="/runtime~main.28d095d2.js" as="script">
<link rel="preload" href="/main.3ecb2d51.js" as="script">
<link rel="preload" href="/1.26bcd1d8.js" as="script">
<link rel="preload" href="/2.f04a5408.js" as="script">
<link rel="preload" href="/3.bfb78e07.js" as="script">
<link rel="preload" href="/1be78505.7300b017.js" as="script">
<link rel="preload" href="/439.83553c85.js" as="script">
<link rel="preload" href="/935f2afb.8f8bc148.js" as="script">
<link rel="preload" href="/17896441.865b1700.js" as="script">
<link rel="preload" href="/f894a538.2da91ca4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><div><nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top navbarHideable_17Wu navbarHidden_19ww"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Alan&#x27;s Blog</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/me">关于我</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/alanwei43" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Alan&#x27;s Blog</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">文档</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">博客</a></li><li class="menu__list-item"><a class="menu__link" href="/me">关于我</a></li><li class="menu__list-item"><a href="https://github.com/alanwei43" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy sidebarWithHideableNavbar_CROi"><a tabindex="-1" class="sidebarLogo_xFc8" href="/"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--light_3CMI"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--dark_3ARp"><strong>Alan&#x27;s Blog</strong></a><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">我的文档列表</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">系列文章</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/">README.md</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">深入浅出ES6</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/0-introduction">ES6是什么</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/1-iterators-and-the-for-of-loop">迭代器和 for-of 循环</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/2-generators">生成器 Generators</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/3-template-string">模板字符串</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/4-rest-parameters-and-defaults">不定参数和默认参数</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/5-destructuring">解构 Destructuring</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/6-arrow-functions">箭头函数 Arrow Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/7-symbols">Symbols</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/8-babel-and-broccoli">学习 Babel 和 Broccoli，马上就用 ES6</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/9-collections">集合</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/10-generators-continued">生成器 Generators，续篇</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/11-proxies-and-reflect">代理 Proxies</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/12-classes">类 Class</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/13-let-and-const">let 和 const</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/14-subclassing">子类 Subclassing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/15-modules">模块 Modules</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/es6-in-depth/16-the-future">展望未来</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Why Java Sucks and C# Rocks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/1-compare-purpose">比较的意义与目的</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/2-basic-type-and-oop">基础类型与面向对象</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/3-attribute-and-annotation">Attribute与Annotation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/4-1-reddit-and-property">Reddit，兼谈C#属性</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/4-generics">泛型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/5-1-standard-event-model">标准事件模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/5-anonymous-method">匿名方法</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/why-java-sucks-and-csharp-rocks/6-yield">yield及其作用</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">RabbitMQ Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/0-install">安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/1-hello-world">Hello World</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/2-WorkQueues">Work Queues</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/3-Publish-Subscribe">Publish/Subscribe</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/4-Routing">Routing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/articles/rabbitmq-guide/5-Topic">Topics</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/articles/rabbitmq-guide/6-RPC">Remote procedure call (RPC)</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">OkHttp Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/okhttp-guide/1-overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/okhttp-guide/2-calls">调用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/okhttp-guide/3-caching">缓存</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/okhttp-guide/4-connections">连接</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/okhttp-guide/5-events">事件</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/articles/okhttp-guide/6-https">HTTPS</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">博文分类</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/">README.md</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/program">编程语言</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/literature">文章转摘</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/server">系统服务</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/docker">Docker</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/editor">编辑器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/mirrors">镜像列表</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/git-guides">Git</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/archives/bookmarks">书签</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">阅读笔记</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/">README.md</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/practical-vim">Vim实用技巧</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Mastering Spring 5.0</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/mastering-spring-5/">目录</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/mastering-spring-5/chapter-1">向 Spring Framework 5.0 进化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/mastering-spring-5/chapter-2">依赖注入</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/mastering-spring-5/chapter-3">使用Spring MVC构建Web应用程序</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/mastering-spring-5/chapter-4">向微服务和云原生应用程序进化</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Redis入门指南 第二版</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/redis-getting-started-2nd/">目录</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/redis-getting-started-2nd/chapter-2">准备</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">React教程笔记</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/">目录</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/advance-context">Context</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/core-12-ReactZheXue">React哲学</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/core-4-components-and-props">组件 &amp; Props</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/core-5-state-and-lifecycle">State &amp; 生命周期</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/core-6-handling-events">事件处理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/react-official-docs/core-9-forms">表单</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/zh.javascript.info">现代 JavaScript 教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/reading/understanding-ecmascript-6">Understanding ECMAScript 6</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Docusaurus 文档翻译</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guides/intro">简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guides/blog">博客</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guides/docs/markdown-features">Markdown 特性</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guides/typescript-support">TypeScript支持</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guides/api/client">Client API</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/guides/theme">主题</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_2WRA"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_CoMu"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Remote procedure call (RPC)</h1></header><div class="markdown"><p><a href="http://www.rabbitmq.com/tutorials/tutorial-six-dotnet.html" target="_blank" rel="noopener noreferrer">英文原文</a></p><p>在第二个教程里我们学习了如何使用工作队列在多个工作者进程之间分发耗时任务。</p><p>但是如果我们需要在远程计算机上运行一个函数并等待结果该如何做呢？嗯，这种事完全不同的使用场景。这种模式通常被称作远程处理调用（Remote Procedure Call）或者简称RPC。</p><p>在这个教程里我们将会使用RabbitMQ建立RPC系统：一个客户端和一个可伸缩的RPC服务器。因为我们没有值得分发的耗时任务，所以我们将会创建一个返回斐波那契数的虚拟RPC服务。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="client-interface"></a>Client interface<a class="hash-link" href="#client-interface" title="Direct link to heading">#</a></h2><p>为了展示如何使用一个RPC服务我们将会创建一个简单的客户端。它将会暴露一个名为call的方法，这个方法发送一个RPC请求并且阻塞直到接收到答案（响应）：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">var rpcClient = new RPCClient();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Console.WriteLine(&quot; [x] Requesting fib(30)&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">var response = rpcClient.Call(&quot;30&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Console.WriteLine(&quot; [.] Got &#x27;{0}&#x27;&quot;, response);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">rpcClient.Close();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Note:</p><p>虽然RPC是一个用于计算的常见模式，但它常常是危险的。当一个程序员没有意识到函数调用是否是本地时或者是一个很慢的RPC调用时问题就会产生。</p><p>解决上面的缺陷，考虑以下建议：</p><p>搞明白哪个函数是本地调用，哪一个是远程调用。</p><p>组织你的系统。让组件之间的依赖保持清晰。</p><p>错误处理情况。当RPC服务器长时间罢工客户端应该怎么反应？</p><p>当上述问题不清楚时避免使用RPC。如果你搞明白了，你应该使用一个阻塞的异步管道取代RPC，结果被异步推送到下一个计算阶段。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="callback-queue"></a>Callback queue<a class="hash-link" href="#callback-queue" title="Direct link to heading">#</a></h2><p>通常通过RabbitMQ执行RPC调用是容易的。一个客户端发送一个请求消息，服务器端回复响应消息。为了能够接受响应我们需要发送一个带有“callback”队列地址的请求。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">var corrId = Guid.NewGuid().ToString();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">var props = channel.CreateBasicProperties();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">props.ReplyTo = replyQueueName;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">props.CorrelationId = corrId;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">var messageBytes = Encoding.UTF8.GetBytes(message);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">channel.BasicPublish(exchange: &quot;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                     routingKey: &quot;rpc_queue&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                     basicProperties: props,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                     body: messageBytes);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">// ... then code to read a response message from the callback_queue ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Note:
消息属性</p><p>AMQP协议给消息预先定义了14个属性集。大部分消暑极少使用，下面几个例外（下面几个常用）：</p><p><code>deliveryMode</code>: 使消息持久化（值为2）或者短暂的（发后即忘模式，其他任意值）。你也许还记得第二个教程里提到的这个属性。</p><p><code>contentType</code>: 用于描述编码的mime-type。比如对于常用的JSON编码设置属性值为application/json是一个好的实践。</p><p><code>replyTo</code>: 一般用于命名回调队列。</p><p><code>correlationId</code>: 常用于关联RPC请求等待响应。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="correlation-id"></a>Correlation Id<a class="hash-link" href="#correlation-id" title="Direct link to heading">#</a></h2><p>在上面发送请求之前的方法里，我们建议为每一个RPC请求创建一个回调队列。那是非常低效的。幸运的是有一个更好的办法：让我们创建单个回调队列每客户端。</p><p>这会产生新的问题，响应不清楚是哪个队列发出的请求。这时候需要使用correlationId属性。我们打算把每个请求的correlationId设置成唯一值。之后，我们在回调队列里接收一条消息，我们将会查看这个属性，然后基于这个属性我们能够匹配这个请求的响应。如果我们看到一个位置的correlationId值，我们可以安全地丢弃消息，这条消息不属于我们的请求。</p><p>You may ask, why should we ignore unknown messages in the callback queue, rather than failing with an error? It&#x27;s due to a possibility of a race condition on the server side. Although unlikely, it is possible that the RPC server will die just after sending us the answer, but before sending an acknowledgment message for the request. If that happens, the restarted RPC server will process the request again. That&#x27;s why on the client we must handle the duplicate responses gracefully, and the RPC should ideally be idempotent. 你也许会问为什么我们在回调队列里忽略未知消息，而不是引发一个错误然后失败。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p><img src="http://www.rabbitmq.com/img/tutorials/python-six.png" alt="summary"></p><p>我们的RPC像这样工作：</p><p>当我们的客户端启动时，它会创建一个匿名排他的回调队列。 </p><p>对于每一个RPC请求，客户端发送的消息都带有两个属性：replayTo，用来标识回调队列，correlationId，为每一次请求设置唯一标识。</p><p>请求被发送到一个<code>rpc_queue</code>队列。</p><p>RPC工作线程（也称作服务器）等待那个队列（rpc_queue）的请求。当请求出现，RPC工作线程开始执行作业并且把作业的结果以消息的形式使用replyTo字段发回客户端，</p><p>客户端在回调队列里等待数据。当消息出现，客户端检查<code>correlationId</code>属性。如果这个属性值和请求里的值匹配，它就会把这个响应返回给应用。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="putting-it-all-together"></a>Putting it all together<a class="hash-link" href="#putting-it-all-together" title="Direct link to heading">#</a></h2><p>斐波那契任务:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">private static int fib(int n)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    if (n == 0 || n == 1) return n;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    return fib(n - 1) + fib(n - 2);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>我们声明我们的斐波那契函数。假设只有正整数有效。（不要这个函数对大数能工作，这可能是最慢的递归实现）。</p><p> RPC server的代码如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using RabbitMQ.Client;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using RabbitMQ.Client.Events;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System.Text;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">class RPCServer</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void Main()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var factory = new ConnectionFactory() { HostName = &quot;localhost&quot; };</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        using(var connection = factory.CreateConnection())</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        using(var channel = connection.CreateModel())</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            channel.QueueDeclare(queue: &quot;rpc_queue&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                 durable: false,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                 exclusive: false,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                 autoDelete: false,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                 arguments: null);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            channel.BasicQos(0, 1, false);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            var consumer = new QueueingBasicConsumer(channel);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            channel.BasicConsume(queue: &quot;rpc_queue&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                 noAck: false,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                 consumer: consumer);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            Console.WriteLine(&quot; [x] Awaiting RPC requests&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            while(true)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                string response = null;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                var ea = (BasicDeliverEventArgs)consumer.Queue.Dequeue();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                var body = ea.Body;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                var props = ea.BasicProperties;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                var replyProps = channel.CreateBasicProperties();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                replyProps.CorrelationId = props.CorrelationId;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                try</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    var message = Encoding.UTF8.GetString(body);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    int n = int.Parse(message);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    Console.WriteLine(&quot; [.] fib({0})&quot;, message);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    response = fib(n).ToString();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                catch(Exception e)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    Console.WriteLine(&quot; [.] &quot; + e.Message);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    response = &quot;&quot;;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                finally</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    var responseBytes = Encoding.UTF8.GetBytes(response);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    channel.BasicPublish(exchange: &quot;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                         routingKey: props.ReplyTo,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                         basicProperties: replyProps,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                         body: responseBytes);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    channel.BasicAck(deliveryTag: ea.DeliveryTag,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                                     multiple: false);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    /// Assumes only valid positive integer input.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    /// Don&#x27;t expect this one to work for big numbers,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    /// and it&#x27;s probably the slowest recursive implementation possible.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    private static int fib(int n)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        if(n == 0 || n == 1)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            return n;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        return fib(n - 1) + fib(n - 2);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">} </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>服务器端代码更简单明了：</p><p>通常我开始先建立连接，通道和声明队列。</p><p>我们也许想运行更多的服务器来处理。为了在多个服务器上负载均衡我们需要设置<code>channel.basicQos</code>的<code>preferchCount</code>。</p><p>我们使用<code>basicConsume</code>来访问队列。然后为了等待请求消息我们进入while循环，执行工作并发送响应。</p><p>RPC客户端代码如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System.Linq;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System.Text;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using RabbitMQ.Client;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">using RabbitMQ.Client.Events;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">class RPCClient</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    private IConnection connection;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    private IModel channel;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    private string replyQueueName;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    private QueueingBasicConsumer consumer;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    public RPCClient()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var factory = new ConnectionFactory() { HostName = &quot;localhost&quot; };</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        connection = factory.CreateConnection();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        channel = connection.CreateModel();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        replyQueueName = channel.QueueDeclare().QueueName;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer = new QueueingBasicConsumer(channel);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        channel.BasicConsume(queue: replyQueueName,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                             noAck: true,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                             consumer: consumer);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    public string Call(string message)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var corrId = Guid.NewGuid().ToString();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var props = channel.CreateBasicProperties();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        props.ReplyTo = replyQueueName;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        props.CorrelationId = corrId;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var messageBytes = Encoding.UTF8.GetBytes(message);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        channel.BasicPublish(exchange: &quot;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                             routingKey: &quot;rpc_queue&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                             basicProperties: props,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                             body: messageBytes);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        while(true)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            var ea = (BasicDeliverEventArgs)consumer.Queue.Dequeue();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            if(ea.BasicProperties.CorrelationId == corrId)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                return Encoding.UTF8.GetString(ea.Body);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    public void Close()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        connection.Close();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">class RPC</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void Main()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var rpcClient = new RPCClient();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        Console.WriteLine(&quot; [x] Requesting fib(30)&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        var response = rpcClient.Call(&quot;30&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        Console.WriteLine(&quot; [.] Got &#x27;{0}&#x27;&quot;, response);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        rpcClient.Close();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>客户端代码涉及了稍微多一些：</p><p>我们建立一个连接和一个通道并且声明一个排他的回调队列用于回复。</p><p>我们订阅了回调队列，所以我们能够接收RPC响应</p><p>我们的call方法执行实际的RPC请求。</p><p>在这里，我们首先声称一个唯一的<code>correlationId</code>数并保存它，在while循环里将会使用这个值捕获合适的响应。</p><p>下面我们发布请求消息，并带有replayTo和correlationId两个属性。</p><p>这个时候我们可以坐下来然后等待直到合适的响应到达。</p><p>while循环做的事情很简单，对于每一个响应消息它（这while循环那段代码）都检查correlationId是否是我们查找的那个。如果是，它会保存响应。最终我们给用户返回响应。</p><p>执行客户端请求：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">RPCClient fibonacciRpc = new RPCClient();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">System.out.println(&quot; [x] Requesting fib(30)&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">String response = fibonacciRpc.call(&quot;30&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">System.out.println(&quot; [.] Got &#x27;&quot; + response + &quot;&#x27;&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">fibonacciRpc.close();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>现在是时候查看我们完整的例子源码了（包括基本的异常处理）：RPCClient.cs和RPCServer.cs。</p><p>像往常一样编译：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ csc /r:&quot;RabbitMQ.Client.dll&quot; RPCClient.cs</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ csc /r:&quot;RabbitMQ.Client.dll&quot; RPCServer.cs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>我们的RPC服务已经准备好了。我们可以启动服务器了：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ RPCServer.exe</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"> [x] Awaiting RPC requests</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>运行下面客户端请求一个斐波那契数：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ RPCClient.exe</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"> [x] Requesting fib(30)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>目前这里的设计不是一个RPC服务唯一可能的实现，但是它给出了一些重要的建议：</p><p>如果RPC服务器很慢，你可以运行一个新的RPC服务器。试着在一个新的控制台运行第二个RPCServer。</p><p>在客户端，RPC要求客户端只能发送和接收一条消息。没有要求像queueDeclare的同步调用。对于单个RPC请求，RPC客户端只需要一次网络来回就可以得到结果。</p><p>目前我们的代码还是非常简单，而且没有尝试解决更复杂（但更重要）的问题，比如：</p><p>如果没有运行的服务器，客户端应该如何反应？</p><p>对于RPC，客户端是否应该有某些类型的超时？</p><p>如果服务器发生故障或者抛出异常，应该把它转发到客户端吗？</p><p>在处理之前阻止无效入站消息（比如检查限制，类型）</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/articles/rabbitmq-guide/5-Topic"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Topics</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/articles/okhttp-guide/1-overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">概述 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#client-interface" class="table-of-contents__link">Client interface</a></li><li><a href="#callback-queue" class="table-of-contents__link">Callback queue</a></li><li><a href="#correlation-id" class="table-of-contents__link">Correlation Id</a></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#putting-it-all-together" class="table-of-contents__link">Putting it all together</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文章列表</h4><ul class="footer__items"><li class="footer__item"> <a class="footer__link-item" href="/docs/articles/es6-in-depth/0-introduction">深入浅出ES6 - InfoQ.cn</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/articles/why-java-sucks-and-csharp-rocks/1-compare-purpose">Why Java Sucks and C# Rocks - 赵劼</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/reading">阅读笔记</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/archives/git-guides">博文归档</a> </li></ul></div><div class="col footer__col"><h4 class="footer__title">文档翻译</h4><ul class="footer__items"><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/guides/blog">Docusaurus Blog</a> </li><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/guides/docs/markdown-features">Docusaurus Markdown</a> </li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"> <a href="https://github.com/alanwei43/node-auto-update" target="_blank" rel="noopener noreferrer" class="footer__link-item">node-auto-update - GitHub</a> </li><li class="footer__item"> <a href="https://github.com/alanwei43/docker-puppeteer" target="_blank" rel="noopener noreferrer" class="footer__link-item">docker-puppeteer - GitHub</a> </li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Alan&#x27;s Blog | <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer">...</a></div></div></div></footer></div></div></div>
<script src="/styles.2421a4af.js"></script>
<script src="/runtime~main.28d095d2.js"></script>
<script src="/main.3ecb2d51.js"></script>
<script src="/1.26bcd1d8.js"></script>
<script src="/2.f04a5408.js"></script>
<script src="/3.bfb78e07.js"></script>
<script src="/1be78505.7300b017.js"></script>
<script src="/439.83553c85.js"></script>
<script src="/935f2afb.8f8bc148.js"></script>
<script src="/17896441.865b1700.js"></script>
<script src="/f894a538.2da91ca4.js"></script>
</body>
</html>