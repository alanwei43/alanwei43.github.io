(window.webpackJsonp=window.webpackJsonp||[]).push([[405],{475:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return i})),n.d(t,"default",(function(){return p}));var r=n(3),o=n(7),a=(n(0),n(506)),s={title:"\u8fde\u63a5",hide_title:!1,hide_table_of_contents:!1,keywords:["okhttp","java"],description:"OkHttp \u8fde\u63a5"},c={unversionedId:"articles/okhttp-guide/4-connections",id:"articles/okhttp-guide/4-connections",isDocsHomePage:!1,title:"\u8fde\u63a5",description:"OkHttp \u8fde\u63a5",source:"@site/src/docs/articles/okhttp-guide/4-connections.md",slug:"/articles/okhttp-guide/4-connections",permalink:"/docs/articles/okhttp-guide/4-connections",editUrl:"https://github.com/alanwei43/blog/tree/master/src/docs/articles/okhttp-guide/4-connections.md",version:"current",sidebar:"docs",previous:{title:"\u7f13\u5b58",permalink:"/docs/articles/okhttp-guide/3-caching"},next:{title:"\u4e8b\u4ef6",permalink:"/docs/articles/okhttp-guide/5-events"}},i=[{value:"URLs",id:"urls",children:[]},{value:"Addresses",id:"addresses",children:[]},{value:"Routes",id:"routes",children:[]},{value:"Connections",id:"connections",children:[]}],l={toc:i};function p(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Although you provide only the URL, OkHttp plans its connection to your webserver using three types: URL, Address, and Route."),Object(a.b)("h2",{id:"urls"},"URLs"),Object(a.b)("p",null,"URLs (like ",Object(a.b)("a",{parentName:"p",href:"https://github.com/square/okhttp"},"https://github.com/square/okhttp"),") are fundamental to HTTP and the Internet. In addition to being a universal, decentralized naming scheme for everything on the web, they also specify how to access web resources."),Object(a.b)("p",null,"URLs are abstract:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"They specify that the call may be plaintext (http) or encrypted (https), but not which cryptographic algorithms should be used. Nor do they specify how to verify the peer\u2019s certificates (the ",Object(a.b)("a",{parentName:"li",href:"http://developer.android.com/reference/javax/net/ssl/HostnameVerifier.html"},"HostnameVerifier"),") or which certificates can be trusted (the ",Object(a.b)("a",{parentName:"li",href:"http://developer.android.com/reference/org/apache/http/conn/ssl/SSLSocketFactory.html"},"SSLSocketFactory"),")."),Object(a.b)("li",{parentName:"ul"},"They don\u2019t specify whether a specific proxy server should be used or how to authenticate with that proxy server.")),Object(a.b)("p",null,"They\u2019re also concrete: each URL identifies a specific path (like /square/okhttp) and query (like ?q=sharks&lang=en). Each webserver hosts many URLs."),Object(a.b)("h2",{id:"addresses"},"Addresses"),Object(a.b)("p",null,"Addresses specify a webserver (like github.com) and all of the static configuration necessary to connect to that server: the port number, HTTPS settings, and preferred network protocols (like HTTP/2 or SPDY)."),Object(a.b)("p",null,"URLs that share the same address may also share the same underlying TCP socket connection. Sharing a connection has substantial performance benefits: lower latency, higher throughput (due to ",Object(a.b)("a",{parentName:"p",href:"http://www.igvita.com/2011/10/20/faster-web-vs-tcp-slow-start/"},"TCP slow start"),") and conserved battery. OkHttp uses a ",Object(a.b)("a",{parentName:"p",href:"http://square.github.io/okhttp/4.x/okhttp/okhttp3/-connection-pool/"},"ConnectionPool")," that automatically reuses HTTP/1.x connections and multiplexes HTTP/2 and SPDY connections."),Object(a.b)("p",null,"In OkHttp some fields of the address come from the URL (scheme, hostname, port) and the rest come from the ",Object(a.b)("a",{parentName:"p",href:"http://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/"},"OkHttpClient"),"."),Object(a.b)("h2",{id:"routes"},"Routes"),Object(a.b)("p",null,"Routes supply the dynamic information necessary to actually connect to a webserver. This is the specific IP address to attempt (as discovered by a DNS query), the exact proxy server to use (if a ",Object(a.b)("a",{parentName:"p",href:"http://developer.android.com/reference/java/net/ProxySelector.html"},"ProxySelector")," is in use), and which version of TLS to negotiate (for HTTPS connections)."),Object(a.b)("p",null,"There may be many routes for a single address. For example, a webserver that is hosted in multiple datacenters may yield multiple IP addresses in its DNS response."),Object(a.b)("h2",{id:"connections"},"Connections"),Object(a.b)("p",null,"When you request a URL with OkHttp, here\u2019s what it does:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"It uses the URL and configured OkHttpClient to create an ",Object(a.b)("strong",{parentName:"li"},"address"),". This address specifies how we\u2019ll connect to the webserver."),Object(a.b)("li",{parentName:"ol"},"It attempts to retrieve a connection with that address from the ",Object(a.b)("strong",{parentName:"li"},"connection pool"),"."),Object(a.b)("li",{parentName:"ol"},"If it doesn\u2019t find a connection in the pool, it selects a ",Object(a.b)("strong",{parentName:"li"},"route")," to attempt. This usually means making a DNS request to get the server\u2019s IP addresses. It then selects a TLS version and proxy server if necessary."),Object(a.b)("li",{parentName:"ol"},"If it\u2019s a new route, it connects by building either a direct socket connection, a TLS tunnel (for HTTPS over an HTTP proxy), or a direct TLS connection. It does TLS handshakes as necessary."),Object(a.b)("li",{parentName:"ol"},"It sends the HTTP request and reads the response.")),Object(a.b)("p",null,"If there\u2019s a problem with the connection, OkHttp will select another route and try again. This allows OkHttp to recover when a subset of a server\u2019s addresses are unreachable. It\u2019s also useful when a pooled connection is stale or if the attempted TLS version is unsupported."),Object(a.b)("p",null,"Once the response has been received, the connection will be returned to the pool so it can be reused for a future request. Connections are evicted from the pool after a period of inactivity."),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},Object(a.b)("a",{parentName:"p",href:"https://square.github.io/okhttp/caching/"},"\u539f\u6587 - Connections"))))}p.isMDXComponent=!0},506:function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return b}));var r=n(0),o=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=o.a.createContext({}),p=function(e){var t=o.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},h=function(e){var t=p(e.components);return o.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=o.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),h=p(n),d=r,b=h["".concat(s,".").concat(d)]||h[d]||u[d]||a;return n?o.a.createElement(b,c(c({ref:t},l),{},{components:n})):o.a.createElement(b,c({ref:t},l))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,s=new Array(a);s[0]=d;var c={};for(var i in t)hasOwnProperty.call(t,i)&&(c[i]=t[i]);c.originalType=e,c.mdxType="string"==typeof e?e:r,s[1]=c;for(var l=2;l<a;l++)s[l]=n[l];return o.a.createElement.apply(null,s)}return o.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);