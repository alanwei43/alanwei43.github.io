<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Alan's Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Alan's Blog Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WSJXZXE31N"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WSJXZXE31N",{anonymize_ip:!0})</script>
<script src="/scripts/baidu.js"></script><title data-react-helmet="true">Spring MVC HandlerInterceptor 简介  -  Alan&#x27;s Blog</title><meta data-react-helmet="true" property="og:title" content="Spring MVC HandlerInterceptor 简介  -  Alan&#x27;s Blog"><meta data-react-helmet="true" name="description" content="描述信息，默认为文章第一段"><meta data-react-helmet="true" property="og:description" content="描述信息，默认为文章第一段"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="/styles.66a1e391.css">
<link rel="preload" href="/styles.27468499.js" as="script">
<link rel="preload" href="/runtime~main.f22299f5.js" as="script">
<link rel="preload" href="/main.82c61660.js" as="script">
<link rel="preload" href="/1.4ac92ab6.js" as="script">
<link rel="preload" href="/2.c0b4586f.js" as="script">
<link rel="preload" href="/3.a606fd85.js" as="script">
<link rel="preload" href="/ccc49370.98d6b933.js" as="script">
<link rel="preload" href="/0396100f.fd4a62d1.js" as="script">
<link rel="preload" href="/62886b37.df2f2854.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><div><nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top navbarHideable_17Wu navbarHidden_19ww"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Alan&#x27;s Blog</strong></a><a class="navbar__item navbar__link" href="/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a><a class="navbar__item navbar__link" href="/me">关于我</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/alanwei43" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Alan&#x27;s Blog</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">文档</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">博客</a></li><li class="menu__list-item"><a class="menu__link" href="/me">关于我</a></li><li class="menu__list-item"><a href="https://github.com/alanwei43" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_1wv2 thin-scrollbar"><h3 class="sidebarItemTitle_3lOc">热门博文</h3><ul class="sidebarItemList_2WIo"><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/tags">Tags列表</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2014/09/04/math-physics-diff">数学系和物理系学生有什么差别？</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2021/02/17/java-network-proxy">设置Java网络代理</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2021/04/23/语文考试可以写负能量作文吗">语文考试可以写负能量作文吗</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2021/04/11/windows-bootable-device">制作Windows启动盘</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2021/04/11/iis-reverse-proxy">配置IIS反向代理</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2021/04/10/node-require-cache">Node require 缓存</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2021/04/02/docker-timezone">Docker时区设置</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2022/03/01/spring-response-image">Spring 响应图片等媒体数据</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2022/02/27/vmware-workstation-pro-keys">VMware Workstation Pro keys</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2022/02/27/vmware-vmrun-cli">VMware 命令行操作虚拟机</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2022/02/27/windows-vmware-tools-drive-fail">VMware的Windows虚拟机中因驱动签名问题无法安装 VMware Tools</a></li><li class="sidebarItem_iPNH"><a class="sidebarItemLink_2E17" href="/blog/2022/02/26/docker-dockerfile-intro">Dockerfile 常用指令介绍</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--lg blogPostTitle_kDB-">Spring MVC HandlerInterceptor 简介</h1><div><time datetime="2021-05-05T00:00:00.000Z" class="blogPostDate_2HVl">May 5, 2021  · 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/alanwei43" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/2927578?s=460&amp;u=153132e7aa3be8295a1703af9b759ca22338f557&amp;v=4" alt="Alan"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/alanwei43" target="_blank" rel="noreferrer noopener">Alan</a></h4><small class="avatar__subtitle">Maintainer of blog</small></div></div></header><section class="markdown"><p><a href="https://www.baeldung.com/spring-mvc-handlerinterceptor" target="_blank" rel="noopener noreferrer">原文 - Introduction to Spring MVC HandlerInterceptor</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="spring-mvc处理程序"></a>Spring MVC处理程序<a class="hash-link" href="#spring-mvc处理程序" title="Direct link to heading">#</a></h2><p>为了理解拦截器, 让我们回头看一下<em>HandlerMapping</em>. 它把一个方法映射到一个URL上, 因此当一个请求进来时, <em>DispatcherServlet</em>能够调用对用的方法.</p><p>事实上, <em>DispatcherServlet</em>使用<em>HandlerAdapter</em>调用方法(Controller里定义的方法).</p><p>现在我们知道了全部上下文 - 拦截器是时候到来了. 我们使用<em>HandlerInterceptor</em>在HTTP请求之前、之后和完成(当视图被渲染)时分别执行一些操作.</p><p>拦截器使用了横切概念, 避免了一些重复性代码, 比如日志、改变Spring模型的一些全局参数等.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="maven依赖"></a>Maven依赖<a class="hash-link" href="#maven依赖" title="Direct link to heading">#</a></h2><p>使用拦截器需要天机以下依赖:</p><div class="mdxCodeBlock_1zKU"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_2eSY">pom.xml</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.springframework</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">spring-web</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">5.2.8.RELEASE</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>最新版本<a href="https://search.maven.org/classic/#search%7Cga%7C1%7Ca%3A%22spring-web%22" target="_blank" rel="noopener noreferrer">点此查看</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="spring-handler-intercetpro"></a>Spring Handler Intercetpro<a class="hash-link" href="#spring-handler-intercetpro" title="Direct link to heading">#</a></h2><p>拦截器和Spring框架提供的<em>HandlerMapping</em>一样, 必须实现<em>HandlerInterceptor</em>接口.</p><p>这个接口包含三个主要方法:</p><ul><li><em>preHanlde()</em> 在处理程序被调用之前执行, 此时视图还未生成</li><li><em>postHandle()</em> 在处理程序被调用之后执行</li><li><em>afterCompletion()</em> 在请求结束和视图生成之后执行</li></ul><p><em>HandlerInterceptor</em> 和 <em>HandlerInterceptorAdapter</em> 的区别在于, 第一个需要手动重写上述所有的三个方法, 而第二个只需要实现需要的方法就行.</p><p><em>preHandle()</em>简单实现:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public boolean preHandle(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletRequest request,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletResponse response, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Object handler) throws Exception {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    // your code</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    return true;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>需要注意的是<em>preHandle</em>方法返回一个boolean值, 用来告诉Spring请求是否应该被后续继续处理.(<em>true</em>表示请求继续被处理, <em>false</em>表示终止后续处理.)</p><p><em>postHandle()</em>简单实现:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public void postHandle(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletRequest request, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletResponse response,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Object handler, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ModelAndView modelAndView) throws Exception {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    // your code</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这个方法在 <strong>HTTP请求被<em>HandlerAdapter</em>处理完成且未生成视图之前</strong> 调用.</p><p>它可以被以多种场景使用, 比如把登录用的头像添加到model中.</p><p>实现<em>HandlerInterceptor</em>需要重写的最后一个方法<em>afterCompletion()</em>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public void afterCompletion(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletRequest request, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletResponse response,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Object handler, Exception ex) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    // your code</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>当视图被生成, 我们可以使用这个钩子方法做一些像收集请求额外诊断数据的事情.</p><p>最后需要记住的是<em>HandlerInterceptor</em>被注册成<em>DefaultAnnotationHandlerMapping</em> bean. <em>DefaultAnnotationHandlerMapping</em> bean被用来负责在所有使用<code>@Controller</code>注解的类上应用拦截器. 此外, 你可以在web应用中指定任意数量的拦截器.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="自定义日志拦截器"></a>自定义日志拦截器<a class="hash-link" href="#自定义日志拦截器" title="Direct link to heading">#</a></h2><p>首先需要创建一个实现<code>HandlerInterceptorAdapter</code>的类:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">public class LoggerInterceptor extends HandlerInterceptorAdapter {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>在拦截器里开启日志:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">private static Logger log = LoggerFactory.getLogger(LoggerInterceptor.class);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>接下来关注拦截器的实现:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="prehandle方法"></a>preHandle方法<a class="hash-link" href="#prehandle方法" title="Direct link to heading">#</a></h3><p>这个方法在请求被处理之前执行, 如果返回<em>true</em>, Spring框架会把请求发送到下一个处理程序方法(或者下一个拦截器). 如果返回<em>false</em>, Spring假设请求被完成处理, 不再需要继续处理.</p><p>我们使用这个钩子(指<em>preHandle()</em>)但因请求参数信息:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public boolean preHandle(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletRequest request,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletResponse response, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Object handler) throws Exception {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    log.info(&quot;[preHandle][&quot; + request + &quot;]&quot; + &quot;[&quot; + request.getMethod()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      + &quot;]&quot; + request.getRequestURI() + getParameters(request));</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    return true;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>在上面这个李自力我们把密码打印出来了，为了去除敏感数据, 下面是<em>getParameters()</em>方法的实现:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">private String getParameters(HttpServletRequest request) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    StringBuffer posted = new StringBuffer();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Enumeration&lt;?&gt; e = request.getParameterNames();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    if (e != null) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        posted.append(&quot;?&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    while (e.hasMoreElements()) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        if (posted.length() &gt; 1) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            posted.append(&quot;&amp;&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        String curr = (String) e.nextElement();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        posted.append(curr + &quot;=&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        if (curr.contains(&quot;password&quot;) </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          || curr.contains(&quot;pass&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          || curr.contains(&quot;pwd&quot;)) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            posted.append(&quot;*****&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        } else {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            posted.append(request.getParameter(curr));</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    String ip = request.getHeader(&quot;X-FORWARDED-FOR&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    String ipAddr = (ip == null) ? getRemoteAddr(request) : ip;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    if (ipAddr!=null &amp;&amp; !ipAddr.equals(&quot;&quot;)) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        posted.append(&quot;&amp;_psip=&quot; + ipAddr); </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    return posted.toString();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">private String getRemoteAddr(HttpServletRequest request) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    String ipFromHeader = request.getHeader(&quot;X-FORWARDED-FOR&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    if (ipFromHeader != null &amp;&amp; ipFromHeader.length() &gt; 0) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        log.debug(&quot;ip from proxy - X-FORWARDED-FOR : &quot; + ipFromHeader);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        return ipFromHeader;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    return request.getRemoteAddr();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="posthandle方法"></a>postHandle方法<a class="hash-link" href="#posthandle方法" title="Direct link to heading">#</a></h3><p>这个钩子在<code>HandlerAdapter</code>调用了处理程序(指URL对应的Controller里的方法), 但是<em>DispatcherServlet</em>尚未渲染视图的时候调用.</p><p>我们可以使用这个方法给<code>ModelAndView</code>添加一些额外属性, 或者检查处理程序方法在处理客户端请求的耗时. </p><p>在我们的例子里, 我们简单打印一下请求:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public void postHandle(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletRequest request, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletResponse response,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Object handler, </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ModelAndView modelAndView) throws Exception {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    log.info(&quot;[postHandle][&quot; + request + &quot;]&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="aftercoimpletion方法"></a>afterCoimpletion方法<a class="hash-link" href="#aftercoimpletion方法" title="Direct link to heading">#</a></h3><p>当请求已经结束, 而且视图已经渲染, 我们可以获取到请求和响应数据, 以及异常信息(如果发生了异常):</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public void afterCompletion(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  HttpServletRequest request, HttpServletResponse response,Object handler, Exception ex) </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  throws Exception {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    if (ex != null){</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        ex.printStackTrace();</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    log.info(&quot;[afterCompletion][&quot; + request + &quot;][exception: &quot; + ex + &quot;]&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="配置"></a>配置<a class="hash-link" href="#配置" title="Direct link to heading">#</a></h2><p>为了把我们新创建的拦截器添加到Spring配置中, 我们需要重写实现了<em>WebMvcConfigurer</em>的<em>WebConfig</em>类中的<em>addInterceptors()</em>方法:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">public void addInterceptors(InterceptorRegistry registry) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    registry.addInterceptor(new LoggerInterceptor());</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>配置被激活之后, 这个拦截器将会处理所有请求.</p><p>如果有多个Spring拦截器被配置, <em>preHandle</em> 方法将会被按照配置的顺序执行, 而<em>postHandle</em>和<em>afterCompletion</em>方法将会被按照相反的顺序执行.</p><p>如果你使用Spring Boot代替了 Spring, 需要注意的是不要忘了在配置类上使用 <code>@EnableWebMvc</code>, 否则我们会在启动时丢失自动配置.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>注意最新版已经不再建议使用<code>HandlerInterceptorAdapter</code>了, 而是实现<code>org.springframework.web.servlet.HandlerInterceptor</code>.</p><p>最新版也不再建议直接继承<code>WebConfig</code>, 而是实现<code>org.springframework.web.servlet.config.annotation.WebMvcConfigurer</code></p></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/java">java</a><a class="margin-horiz--sm" href="/blog/tags/spring">spring</a></div></footer></article><div><a href="https://github.com/alanwei43/blog/tree/master/src/blog/2021-05-05-spring-mvc-handlerinterceptor.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/05/05/spring-mvc-custom-handler-interceptor"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« 使用自定义的Spring MVC处理程序拦截器管理会话</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/05/04/spring-boot-jsp"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Spring Boot 使用 JSP »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spring-mvc处理程序" class="table-of-contents__link">Spring MVC处理程序</a></li><li><a href="#maven依赖" class="table-of-contents__link">Maven依赖</a></li><li><a href="#spring-handler-intercetpro" class="table-of-contents__link">Spring Handler Intercetpro</a></li><li><a href="#自定义日志拦截器" class="table-of-contents__link">自定义日志拦截器</a><ul><li><a href="#prehandle方法" class="table-of-contents__link">preHandle方法</a></li><li><a href="#posthandle方法" class="table-of-contents__link">postHandle方法</a></li><li><a href="#aftercoimpletion方法" class="table-of-contents__link">afterCoimpletion方法</a></li></ul></li><li><a href="#配置" class="table-of-contents__link">配置</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文章列表</h4><ul class="footer__items"><li class="footer__item"> <a class="footer__link-item" href="/docs/articles/es6-in-depth/0-introduction">深入浅出ES6 - InfoQ.cn</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/articles/why-java-sucks-and-csharp-rocks/1-compare-purpose">Why Java Sucks and C# Rocks - 赵劼</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/reading">阅读笔记</a> </li><li class="footer__item"> <a class="footer__link-item" href="/docs/archives/git-guides">博文归档</a> </li></ul></div><div class="col footer__col"><h4 class="footer__title">文档翻译</h4><ul class="footer__items"><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/guides/blog">Docusaurus Blog</a> </li><li class="footer__item"> <a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="/docs/guides/docs/markdown-features">Docusaurus Markdown</a> </li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"> <a href="https://github.com/alanwei43/node-auto-update" target="_blank" rel="noopener noreferrer" class="footer__link-item">node-auto-update - GitHub</a> </li><li class="footer__item"> <a href="https://github.com/alanwei43/docker-puppeteer" target="_blank" rel="noopener noreferrer" class="footer__link-item">docker-puppeteer - GitHub</a> </li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Alan&#x27;s Blog | <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer">...</a></div></div></div></footer></div></div></div>
<script src="/styles.27468499.js"></script>
<script src="/runtime~main.f22299f5.js"></script>
<script src="/main.82c61660.js"></script>
<script src="/1.4ac92ab6.js"></script>
<script src="/2.c0b4586f.js"></script>
<script src="/3.a606fd85.js"></script>
<script src="/ccc49370.98d6b933.js"></script>
<script src="/0396100f.fd4a62d1.js"></script>
<script src="/62886b37.df2f2854.js"></script>
</body>
</html>